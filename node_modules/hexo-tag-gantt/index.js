/**
 * Created by three on 15/10/22.
 */

'use strict';

var fs = require('hexo-fs');
var Promise = require('bluebird');
var process = require('child_process');
//var gm = require('gm');
//var imageMagick = gm.subClass({imageMagick:true})
function guid() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

var mermaidDiagramType = {
    gantt: 'gantt',
    flow: 'graph',
    sequence: 'sequenceDiagram'
};

hexo.extend.tag.register('mermaid', function (args, content) {

    return new Promise(function (resolve, reject) {
        var directory = './source/';



        var diagramType = args[0];
        var data = [mermaidDiagramType[diagramType]];

        if(args==='gantt') {
            data.push('title ' + args[1])
        } else if(args==='graph') {
            data.length = 0;
            data.push(mermaidDiagramType[diagramType]+' ' + args[1])
        }

        data.push(content);
        data = data.join('\r\n');
       // var path = directory + guid();
        var path = directory + 'gantt'

	var svgPath = path + '.mmd.svg';
        var pngPath = path + '.mmd.png';

        if(fs.existsSync(path +'.mmd')) {
            try {
               fs.unlink(path +'.mmd');
            } catch (e) {

            }
        }
        if(fs.existsSync(pngPath )) {
            try {
               fs.unlink(pngPath );
            } catch (e) {

            }
        }
        fs.writeFileSync(path+ '.mmd', data);

        var cmd = './node_modules/.bin/mermaid ' + path + '.mmd -o ' + directory + ' -s -p';
	console.log(cmd);
        process.exec(cmd, {setsid: false}, function (error, stdout, stderr) {
     //       console.log(stderr);
       //     console.log(stdout);
         //   console.log(error);
	    console.log(cmd);
            if (error !== null) {
                console.log('exec error: ' + error);
                reject("<h3>gantt 生成失败</h3>")
            } else {
                var svg = fs.readFileSync(svgPath);
/*		    imageMagick(pngPath).crop(917-260,90-30,260,30).resize(1000, 500).autoOrient().write(pngPath, function(err){
			    if(err)console.log(err);
		    });*/
                resolve('<div style="overflow: scroll;">' + svg + '</div>');
                fs.unlink(svgPath);
            }
               // fs.unlink(path+'.mmd');
        });

    }).then(function (data) {
            return data;
        }, function (err) {
            return err;
        });

}, {async: true, ends: true});
